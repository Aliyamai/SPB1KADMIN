<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - TVET Perantisan</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f8f9fa;
      color: #333;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 40px;
      background: #fffffe;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .logo img {
      height: 70px;
      width: auto;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .admin-details {
      text-align: right;
    }

    .admin-name {
      color: #1e293b;
      font-weight: 600;
      font-size: 15px;
    }

    .admin-role {
      color: #64748b;
      font-size: 12px;
    }

    .logout-btn {
      background: #ef4444;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      transition: 0.3s;
      cursor: pointer;
      border: none;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    .container {
      width: 90%;
      max-width: 1400px;
      margin: 30px auto;
    }

    .page-title {
      font-size: 28px;
      color: #1e293b;
      margin-bottom: 30px;
      border-left: 6px solid #f97316;
      padding-left: 15px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
      border-left: 5px solid #f97316;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card.pending {
      border-left-color: #f59e0b;
    }

    .stat-card.approved {
      border-left-color: #10b981;
    }

    .stat-card.total {
      border-left-color: #3b82f6;
    }

    .stat-card.new {
      border-left-color: #8b5cf6;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-icon {
      font-size: 32px;
      opacity: 0.8;
    }

    .stat-label {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #1e293b;
    }

    .stat-change {
      font-size: 13px;
      color: #10b981;
      margin-top: 8px;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 22px;
      color: #1e293b;
      border-left: 5px solid #f97316;
      padding-left: 12px;
    }

    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .course-card {
      background: #f8f9fa;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .course-card:hover {
      border-color: #f97316;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .course-card.selected {
      border-color: #f97316;
      background: #fff5ec;
      box-shadow: 0 5px 15px rgba(249, 115, 22, 0.2);
    }

    .course-name {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .course-stats {
      display: flex;
      gap: 15px;
      margin-top: 12px;
      font-size: 13px;
    }

    .course-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .course-stat.pending {
      color: #f59e0b;
    }

    .course-stat.approved {
      color: #10b981;
    }

    .course-stat.total {
      color: #64748b;
    }

    .click-hint {
      margin-top: 12px;
      font-size: 12px;
      color: #94a3b8;
      font-style: italic;
    }

    .course-card.selected .click-hint {
      color: #f97316;
      font-weight: 500;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
      color: #64748b;
      font-weight: 500;
    }

    .filter-btn:hover {
      border-color: #f97316;
      color: #f97316;
    }

    .filter-btn.active {
      background: #f97316;
      color: white;
      border-color: #f97316;
    }

    .back-btn {
      padding: 8px 16px;
      border: 2px solid #f97316;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
      color: #f97316;
      font-weight: 500;
      margin-bottom: 20px;
    }

    .back-btn:hover {
      background: #f97316;
      color: white;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #475569;
      font-size: 14px;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #e2e8f0;
      color: #475569;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-approved {
      background: #d1fae5;
      color: #065f46;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .action-btns {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.3s;
      font-weight: 500;
    }

    .btn-view {
      background: #3b82f6;
      color: white;
    }

    .btn-view:hover {
      background: #2563eb;
    }

    .btn-approve {
      background: #10b981;
      color: white;
    }

    .btn-approve:hover {
      background: #059669;
    }

    .btn-reject {
      background: #ef4444;
      color: white;
    }

    .btn-reject:hover {
      background: #dc2626;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .hidden {
      display: none;
    }

    footer {
      text-align: center;
      padding: 30px;
      color: #64748b;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .courses-grid {
        grid-template-columns: 1fr;
      }

      .filter-buttons {
        flex-wrap: wrap;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      header {
        padding: 15px 20px;
      }

      .admin-info {
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <img src="assets/images/skimperantisan.png" alt="Logo TVET" onerror="this.style.display='none'">
    </div>
    <div class="admin-info">
      <div class="admin-details">
        <div class="admin-name" id="adminName">üë§ Admin</div>
        <div class="admin-role" id="adminRole">Loading...</div>
      </div>
      <button class="logout-btn" onclick="handleLogout()">Log Keluar</button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <h1 class="page-title">Dashboard Admin</h1>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card pending">
        <div class="stat-header">
          <div>
            <div class="stat-label">Permohonan Pending</div>
            <div class="stat-value" id="pendingCount">-</div>
            <div class="stat-change">‚è≥ Menunggu kelulusan</div>
          </div>
          <div class="stat-icon">‚è±Ô∏è</div>
        </div>
      </div>

      <div class="stat-card approved">
        <div class="stat-header">
          <div>
            <div class="stat-label">Pelajar Diterima</div>
            <div class="stat-value" id="approvedCount">-</div>
            <div class="stat-change">‚úÖ Permohonan diluluskan</div>
          </div>
          <div class="stat-icon">‚úÖ</div>
        </div>
      </div>

      <div class="stat-card total">
        <div class="stat-header">
          <div>
            <div class="stat-label">Jumlah Permohonan</div>
            <div class="stat-value" id="totalStudents">-</div>
            <div class="stat-change">üìä Total keseluruhan</div>
          </div>
          <div class="stat-icon">üë•</div>
        </div>
      </div>

      <div class="stat-card new">
        <div class="stat-header">
          <div>
            <div class="stat-label">Permohonan Baru</div>
            <div class="stat-value" id="newCount">-</div>
            <div class="stat-change">üÜï 7 hari terakhir</div>
          </div>
          <div class="stat-icon">üìù</div>
        </div>
      </div>
    </div>

    <!-- Courses Overview Section -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Pilih Kursus Untuk Lihat Permohonan</h2>
      </div>
      <div class="courses-grid" id="coursesGrid">
        <div class="loading">Memuatkan data kursus...</div>
      </div>
    </div>

    <!-- Applications Table (Hidden by default) -->
    <div class="section hidden" id="applicationsSection">
      <button class="back-btn" onclick="closeApplicationsTable()">‚Üê Kembali ke Senarai Kursus</button>
      
      <div class="section-header">
        <h2 class="section-title" id="courseTitle">Senarai Permohonan</h2>
        <div class="filter-buttons">
          <button class="filter-btn active" onclick="filterByStatus('semua')">Semua</button>
          <button class="filter-btn" onclick="filterByStatus('pending')">Pending</button>
          <button class="filter-btn" onclick="filterByStatus('diterima')">Diterima</button>
          <button class="filter-btn" onclick="filterByStatus('ditolak')">Ditolak</button>
        </div>
      </div>

      <div class="table-container">
        <table id="applicationsTable">
          <thead>
            <tr>
              <th>No.</th>
              <th>Nama Pemohon</th>
              <th>Tarikh Mohon</th>
              <th>Status</th>
              <th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="5" class="loading">Memuatkan data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>¬© 2025 Skim Perantisan Belia Kemahiran TVET. Hak Cipta Terpelihara.</p>
  </footer>

  <script>
    // Google Apps Script Web App URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFaX8iZ8QhLcMOT-sWTYl0p0w9UJYgQmY-EZo8xn6x23Q96eVu5pus4GGTW_WjkR7y/exec'; // Replace with your deployed Apps Script URL

    // Define courses with their sheet names
    const COURSES = [
      { name: 'Elektrik', sheetName: 'ELEKTRIK' },
      { name: 'Multimedia', sheetName: 'MULTIMEDIA' }
    ];

    let allApplications = [];
    let currentStatusFilter = 'semua';
    let currentCourseFilter = null;

    // Check authentication
    function checkAuthentication() {
      const loggedIn = localStorage.getItem('tvet_admin_logged_in') || 
                      sessionStorage.getItem('tvet_admin_logged_in');
      
      if (loggedIn !== 'true') {
        window.location.href = 'adminlogin.html';
        return false;
      }
      
      loadAdminData();
      return true;
    }

    // Load admin data
    function loadAdminData() {
      const storage = localStorage.getItem('tvet_admin_name') ? localStorage : sessionStorage;
      
      const adminName = storage.getItem('tvet_admin_name') || 'Admin';
      const adminRole = storage.getItem('tvet_admin_role') || 'Administrator';
      const adminEmail = storage.getItem('tvet_admin_email') || '';
      
      document.getElementById('adminName').textContent = `üë§ ${adminName}`;
      document.getElementById('adminRole').textContent = `${adminRole}${adminEmail ? ' ‚Ä¢ ' + adminEmail : ''}`;
    }

    // Handle logout
    function handleLogout() {
      if (confirm('Adakah anda pasti ingin log keluar?')) {
        localStorage.removeItem('tvet_admin_logged_in');
        localStorage.removeItem('tvet_admin_username');
        localStorage.removeItem('tvet_admin_name');
        localStorage.removeItem('tvet_admin_email');
        localStorage.removeItem('tvet_admin_role');
        
        sessionStorage.removeItem('tvet_admin_logged_in');
        sessionStorage.removeItem('tvet_admin_username');
        sessionStorage.removeItem('tvet_admin_name');
        sessionStorage.removeItem('tvet_admin_email');
        sessionStorage.removeItem('tvet_admin_role');
        
        window.location.href = 'adminlogin.html';
      }
    }

    // Fetch data from Google Sheets via Apps Script
    async function fetchSheetData(sheetName) {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'getApplications',
            course: sheetName
          })
        });
        
        if (!response.ok) {
          throw new Error(`Failed to fetch ${sheetName}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          return result.data.applications || [];
        } else {
          console.error(result.message);
          return [];
        }
      } catch (error) {
        console.error(`Error fetching ${sheetName}:`, error);
        return [];
      }
    }

    // Parse sheet data to applications
    function parseSheetData(values, courseName) {
      if (values.length < 2) return [];
      
      const headers = values[0];
      const rows = values.slice(1);
      
      return rows.map((row, index) => {
        const app = {
          id: `${courseName}-${index}`,
          course: courseName,
          timestamp: row[0] || '',
          nama: row[1] || '',
          no_kp: row[2] || '',
          jantina: row[3] || '',
          agama: row[4] || '',
          warganegara: row[5] || '',
          alamat: row[6] || '',
          no_tel_rumah: row[7] || '',
          no_tel_bimbit: row[8] || '',
          email: row[9] || '',
          lulusan: row[10] || '',
          keputusan: row[11] || '',
          lain_lain: row[12] || '',
          nama_bapa: row[13] || '',
          no_kp_bapa: row[14] || '',
          keturunan_bapa: row[15] || '',
          pekerjaan_bapa: row[16] || '',
          pendapatan_bapa: row[17] || '',
          no_tel_bapa: row[18] || '',
          nama_ibu: row[19] || '',
          no_kp_ibu: row[20] || '',
          keturunan_ibu: row[21] || '',
          pekerjaan_ibu: row[22] || '',
          pendapatan_ibu: row[23] || '',
          no_tel_ibu: row[24] || '',
          status_kesihatan: row[25] || '',
          masalah_kesihatan: row[26] || '',
          pengakuan: row[27] || '',
          status: row[28] || 'pending'
        };
        
        return app;
      });
    }

    // Load all course data
    async function loadAllData() {
      allApplications = [];
      
      for (const course of COURSES) {
        const data = await fetchSheetData(course.sheetName);
        const apps = parseSheetData(data, course.name);
        allApplications = allApplications.concat(apps);
      }
      
      renderCoursesGrid();
      updateStats();
    }

    // Get course statistics
    function getCourseStats() {
      const stats = {};
      
      COURSES.forEach(course => {
        const courseApps = allApplications.filter(app => app.course === course.name);
        const pending = courseApps.filter(app => 
          (app.status || '').toLowerCase() === 'pending'
        ).length;
        const approved = courseApps.filter(app => 
          (app.status || '').toLowerCase() === 'diterima'
        ).length;
        
        stats[course.name] = {
          pending: pending,
          approved: approved,
          total: courseApps.length
        };
      });
      
      return stats;
    }

    // Render courses grid
    function renderCoursesGrid() {
      const grid = document.getElementById('coursesGrid');
      const stats = getCourseStats();
      
      let html = '';
      
      COURSES.forEach(course => {
        const stat = stats[course.name];
        const isSelected = currentCourseFilter === course.name;
        
        html += `
          <div class="course-card ${isSelected ? 'selected' : ''}" onclick="filterByCourse('${course.name}')">
            <div class="course-name">${course.name}</div>
            <div class="course-stats">
              <div class="course-stat pending">
                <span>‚è≥</span>
                <span>${stat.pending} pending</span>
              </div>
              <div class="course-stat approved">
                <span>‚úÖ</span>
                <span>${stat.approved} diterima</span>
              </div>
            </div>
            <div class="course-stats">
              <div class="course-stat total">
                <span>üìä</span>
                <span>Jumlah: ${stat.total}</span>
              </div>
            </div>
            <div class="click-hint">${isSelected ? '‚úì Dipilih' : 'Klik untuk lihat permohonan ‚Üí'}</div>
          </div>
        `;
      });
      
      grid.innerHTML = html;
    }

    // Filter by course
    function filterByCourse(courseName) {
      currentCourseFilter = courseName;
      currentStatusFilter = 'semua';
      
      // Reset filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === 'Semua') {
          btn.classList.add('active');
        }
      });
      
      renderCoursesGrid();
      showApplicationsTable();
    }

    // Show applications table
    function showApplicationsTable() {
      document.getElementById('applicationsSection').classList.remove('hidden');
      document.getElementById('courseTitle').textContent = `Senarai Permohonan - Kursus ${currentCourseFilter}`;
      renderTable();
      
      // Scroll to table
      document.getElementById('applicationsSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Close applications table
    function closeApplicationsTable() {
      currentCourseFilter = null;
      document.getElementById('applicationsSection').classList.add('hidden');
      renderCoursesGrid();
      
      // Scroll back to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Filter by status
    function filterByStatus(status) {
      currentStatusFilter = status;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      renderTable();
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      let filtered = allApplications.filter(app => app.course === currentCourseFilter);
      
      // Filter by status
      if (currentStatusFilter !== 'semua') {
        filtered = filtered.filter(app => 
          (app.status || '').toLowerCase() === currentStatusFilter
        );
      }

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <p>Tiada permohonan dijumpai</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      filtered.forEach((app, index) => {
        const row = document.createElement('tr');
        
        const status = (app.status || 'pending').toLowerCase();
        const statusClass = `status-${status === 'diterima' ? 'approved' : status === 'ditolak' ? 'rejected' : 'pending'}`;
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);

        const name = app.nama || '-';
        const date = app.timestamp ? new Date(app.timestamp).toLocaleDateString('ms-MY') : '-';

        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${name}</td>
          <td>${date}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>
            <div class="action-btns">
              <button class="action-btn btn-view" onclick='viewApplication(${JSON.stringify(app).replace(/'/g, "&#39;")})'>Lihat</button>
              ${status === 'pending' ? `
                <button class="action-btn btn-approve" onclick='approveApplication("${app.id}")'>Terima</button>
                <button class="action-btn btn-reject" onclick='rejectApplication("${app.id}")'>Tolak</button>
              ` : ''}
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Update statistics
    function updateStats() {
      const pending = allApplications.filter(app => 
        (app.status || '').toLowerCase() === 'pending'
      ).length;
      const approved = allApplications.filter(app => 
        (app.status || '').toLowerCase() === 'diterima'
      ).length;
      const total = allApplications.length;
      
      // Calculate new applications (last 7 days)
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const newApps = allApplications.filter(app => {
        if (!app.timestamp) return false;
        const appDate = new Date(app.timestamp);
        return appDate >= weekAgo;
      }).length;

      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('totalStudents').textContent = total;
      document.getElementById('newCount').textContent = newApps;
    }

    // Application actions
    function viewApplication(app) {
      // Store application data in sessionStorage
      sessionStorage.setItem('viewing_application', JSON.stringify(app));
      // Navigate to view page
      window.location.href = 'view-application.html';
    }